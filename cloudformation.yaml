AWSTemplateFormatVersion: '2010-09-09'
Description: Keep It Krispy - AI-Powered Meeting Memory Infrastructure

Parameters:
  ProjectName:
    Type: String
    Default: krisp-buddy
    Description: Project name prefix for resources

  KrispWebhookAuthKey:
    Type: String
    Default: ''
    NoEcho: true
    Description: Optional auth key for Krisp webhook validation

Resources:
  # S3 Bucket for Transcripts
  TranscriptsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'krisp-transcripts-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # S3 Vectors Bucket
  VectorsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'krisp-vectors-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # DynamoDB Table for Metadata Index
  TranscriptsIndex:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-transcripts-index
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: meeting_id
          AttributeType: S
        - AttributeName: date
          AttributeType: S
        - AttributeName: speaker_name
          AttributeType: S
        - AttributeName: pk
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: meeting_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: date-index
          KeySchema:
            - AttributeName: date
              KeyType: HASH
            - AttributeName: meeting_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: speaker-index
          KeySchema:
            - AttributeName: speaker_name
              KeyType: HASH
            - AttributeName: date
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: all-transcripts-index
          KeySchema:
            - AttributeName: pk
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: user-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Companies
  CompaniesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-companies
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: pk
          AttributeType: S
        - AttributeName: mentionCount
          AttributeType: N
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: all-companies-index
          KeySchema:
            - AttributeName: pk
              KeyType: HASH
            - AttributeName: mentionCount
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Entities (Universal Entity Store)
  EntitiesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-entities
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: entity_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: entity_type
          AttributeType: S
        - AttributeName: team_id
          AttributeType: S
        - AttributeName: canonical_name
          AttributeType: S
      KeySchema:
        - AttributeName: entity_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user-type-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: entity_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: type-name-index
          KeySchema:
            - AttributeName: entity_type
              KeyType: HASH
            - AttributeName: canonical_name
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: team-type-index
          KeySchema:
            - AttributeName: team_id
              KeyType: HASH
            - AttributeName: entity_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Relationships (Graph Edges)
  RelationshipsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-relationships
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: relationship_id
          AttributeType: S
        - AttributeName: from_entity_id
          AttributeType: S
        - AttributeName: to_entity_id
          AttributeType: S
        - AttributeName: rel_type
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: relationship_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: from-index
          KeySchema:
            - AttributeName: from_entity_id
              KeyType: HASH
            - AttributeName: rel_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: to-index
          KeySchema:
            - AttributeName: to_entity_id
              KeyType: HASH
            - AttributeName: rel_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: user-type-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: rel_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Documents
  DocumentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-documents
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: document_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
        - AttributeName: file_hash
          AttributeType: S
      KeySchema:
        - AttributeName: document_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: hash-index
          KeySchema:
            - AttributeName: file_hash
              KeyType: HASH
          Projection:
            ProjectionType: KEYS_ONLY

  # DynamoDB Table for Invitations
  InvitesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-invites
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: invite_token
          AttributeType: S
        - AttributeName: inviter_id
          AttributeType: S
        - AttributeName: invitee_email
          AttributeType: S
      KeySchema:
        - AttributeName: invite_token
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: inviter-index
          KeySchema:
            - AttributeName: inviter_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: email-index
          KeySchema:
            - AttributeName: invitee_email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  # DynamoDB Table for Audit Logs (SOC2 Compliance)
  AuditLogsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-audit-logs
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: log_id
          AttributeType: S
        - AttributeName: actor_id
          AttributeType: S
        - AttributeName: target_id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: log_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: actor-index
          KeySchema:
            - AttributeName: actor_id
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: target-index
          KeySchema:
            - AttributeName: target_id
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # IAM Role for Webhook Lambda
  WebhookLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-webhook-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3WriteAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource: !Sub '${TranscriptsBucket.Arn}/*'
        - PolicyName: DynamoDBWriteAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                Resource: !GetAtt TranscriptsIndex.Arn
        - PolicyName: ApiKeyLookup
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/krisp-api-keys'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/krisp-api-keys/index/*'

  # IAM Role for Processor Lambda
  ProcessorLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-processor-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: ProcessorAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub '${TranscriptsBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt TranscriptsIndex.Arn
                  - !Sub '${TranscriptsIndex.Arn}/index/*'
                  - !GetAtt CompaniesTable.Arn
                  - !Sub '${CompaniesTable.Arn}/index/*'
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-embed-text-v2:0'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.nova-lite-v1:0'
              - Effect: Allow
                Action:
                  - s3vectors:PutVectors
                  - s3vectors:GetVectors
                  - s3vectors:QueryVectors
                  - s3vectors:DeleteVectors
                Resource:
                  - !Sub 'arn:aws:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/krisp-vectors-${AWS::AccountId}'
                  - !Sub 'arn:aws:s3vectors:${AWS::Region}:${AWS::AccountId}:bucket/krisp-vectors-${AWS::AccountId}/index/*'

  # Webhook Lambda Function
  WebhookFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-webhook'
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt WebhookLambdaRole.Arn
      Timeout: 30
      MemorySize: 128
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          KRISP_S3_BUCKET: !Ref TranscriptsBucket
          KRISP_WEBHOOK_AUTH_KEY: !Ref KrispWebhookAuthKey
          DYNAMODB_TABLE: !Ref TranscriptsIndex
      Code:
        ZipFile: |
          import json
          import os
          import boto3
          import hashlib
          from datetime import datetime

          s3 = boto3.client('s3')
          dynamodb = boto3.resource('dynamodb')
          BUCKET_NAME = os.environ.get('KRISP_S3_BUCKET', '')
          DYNAMODB_TABLE = os.environ.get('DYNAMODB_TABLE', 'krisp-transcripts-index')
          API_KEYS_TABLE = 'krisp-api-keys'

          def hash_api_key(key):
              return hashlib.sha256(key.encode()).hexdigest()

          def get_user_from_api_key(api_key):
              """Look up user_id from API key"""
              key_hash = hash_api_key(api_key)
              table = dynamodb.Table(API_KEYS_TABLE)
              response = table.query(
                  IndexName='keyid-index',
                  KeyConditionExpression='key_hash = :kh',
                  ExpressionAttributeValues={':kh': key_hash}
              )
              items = response.get('Items', [])
              if items and items[0].get('status') == 'active':
                  return items[0].get('user_id')
              return None

          def lambda_handler(event, context):
              headers = event.get('headers', {})

              # Get API key from X-API-Key header
              api_key = headers.get('x-api-key', '')
              if not api_key:
                  return {'statusCode': 401, 'body': json.dumps({'error': 'API key required. Set X-API-Key header.'})}

              # Look up user from API key
              user_id = get_user_from_api_key(api_key)
              if not user_id:
                  return {'statusCode': 401, 'body': json.dumps({'error': 'Invalid or revoked API key'})}

              body = event.get('body', '{}')
              if event.get('isBase64Encoded', False):
                  import base64
                  body = base64.b64decode(body).decode('utf-8')

              try:
                  payload = json.loads(body)
              except json.JSONDecodeError as e:
                  return {'statusCode': 400, 'body': json.dumps({'error': 'Invalid JSON'})}

              event_type = payload.get('event', 'unknown')

              # Extract meeting data from nested structure
              data = payload.get('data', {})
              meeting = data.get('meeting', {})

              meeting_id = meeting.get('id') or payload.get('meeting_id', payload.get('meetingId', 'unknown'))
              meeting_title = meeting.get('title') or payload.get('title', 'Untitled')
              duration = meeting.get('duration', 0)
              url = meeting.get('url', '')

              # Extract speakers from participants
              participants = meeting.get('participants', [])
              speakers = list(set(p.get('name', '') for p in participants if p.get('name')))

              now = datetime.utcnow()
              date_prefix = now.strftime('%Y/%m/%d')
              date_str = now.strftime('%Y-%m-%d')
              timestamp = now.strftime('%Y%m%d_%H%M%S')
              received_at = now.isoformat() + 'Z'

              safe_title = "".join(c if c.isalnum() or c in (' ', '-', '_') else '_' for c in meeting_title)[:50]
              s3_key = f"meetings/{date_prefix}/{timestamp}_{safe_title}_{meeting_id}.json"

              enriched_payload = {
                  'received_at': received_at,
                  'event_type': event_type,
                  'raw_payload': payload
              }

              # Write to S3
              s3.put_object(
                  Bucket=BUCKET_NAME,
                  Key=s3_key,
                  Body=json.dumps(enriched_payload, indent=2, default=str),
                  ContentType='application/json'
              )

              # Write to DynamoDB immediately for fast queries
              table = dynamodb.Table(DYNAMODB_TABLE)
              dynamo_item = {
                  'pk': 'TRANSCRIPT',
                  'meeting_id': meeting_id,
                  'title': meeting_title,
                  'date': date_str,
                  'timestamp': received_at,
                  'duration': int(duration) if duration else 0,
                  's3_key': s3_key,
                  'event_type': event_type,
                  'received_at': received_at,
                  'indexed_at': received_at,
                  'user_id': user_id,  # Multi-tenant isolation
              }
              if speakers:
                  dynamo_item['speakers'] = speakers
                  dynamo_item['speaker_name'] = speakers[0].lower() if speakers else ''
              if url:
                  dynamo_item['url'] = url

              table.put_item(Item=dynamo_item)

              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'Webhook received', 'event_type': event_type, 's3_key': s3_key})
              }

  # Webhook Lambda Version (for SnapStart)
  WebhookFunctionVersion:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref WebhookFunction
      Description: SnapStart enabled version

  # Webhook Lambda Alias (for SnapStart with Function URL)
  WebhookFunctionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WebhookFunction
      FunctionVersion: !GetAtt WebhookFunctionVersion.Version
      Name: live

  # Webhook Lambda URL (points to alias for SnapStart)
  WebhookFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      TargetFunctionArn: !Ref WebhookFunctionAlias
      Cors:
        AllowMethods:
          - POST
        AllowOrigins:
          - '*'

  # Permission for Lambda URL
  WebhookFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebhookFunctionAlias
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
      FunctionUrlAuthType: NONE

  # Processor Lambda Function (placeholder - needs full code deployment)
  ProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-processor'
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt ProcessorLambdaRole.Arn
      Timeout: 120
      MemorySize: 512
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          KRISP_S3_BUCKET: !Ref TranscriptsBucket
          DYNAMODB_TABLE: !Ref TranscriptsIndex
          VECTOR_BUCKET: !Ref VectorsBucket
          VECTOR_INDEX: transcript-chunks
      Code:
        ZipFile: |
          # Placeholder - deploy full processor code separately
          # This creates DynamoDB entries and vector embeddings
          def handler(event, context):
              print("Processor triggered - deploy full code from repo")
              return {"status": "placeholder"}

  # Processor Lambda Version (for SnapStart)
  ProcessorFunctionVersion:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref ProcessorFunction
      Description: SnapStart enabled version

  # Processor Lambda Alias (for SnapStart)
  ProcessorFunctionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref ProcessorFunction
      FunctionVersion: !GetAtt ProcessorFunctionVersion.Version
      Name: live

  # Permission for S3 to invoke Processor Lambda (via alias)
  ProcessorS3Permission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ProcessorFunctionAlias
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceArn: !GetAtt TranscriptsBucket.Arn
      SourceAccount: !Ref AWS::AccountId

  # DynamoDB Table for Morning Briefings
  BriefingsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: krisp-briefings
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: briefing_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: date
          AttributeType: S
      KeySchema:
        - AttributeName: briefing_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user-date-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: date
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # IAM Role for Morning Briefing Lambda
  MorningBriefingLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-morning-briefing-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: MorningBriefingAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub '${TranscriptsBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt TranscriptsIndex.Arn
                  - !Sub '${TranscriptsIndex.Arn}/index/*'
              - Effect: Allow
                Action:
                  - dynamodb:Scan
                Resource:
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/krisp-users'
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt BriefingsTable.Arn
                  - !Sub '${BriefingsTable.Arn}/index/*'
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.nova-lite-v1:0'

  # Morning Briefing Lambda Function
  MorningBriefingFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-morning-briefing'
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt MorningBriefingLambdaRole.Arn
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          KRISP_S3_BUCKET: !Ref TranscriptsBucket
          DYNAMODB_TABLE: !Ref TranscriptsIndex
          BRIEFINGS_TABLE: !Ref BriefingsTable
          USERS_TABLE: krisp-users
          BRIEFING_MODEL_ID: amazon.nova-lite-v1:0
      Code:
        ZipFile: |
          # Placeholder - deploy full code from lambda/morning-briefing/handler.py
          def handler(event, context):
              print("Morning briefing triggered - deploy full code from repo")
              return {"status": "placeholder"}

  # CloudWatch Events Rule for Daily Morning Briefing (7am UTC)
  MorningBriefingSchedule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-morning-briefing-schedule'
      Description: Trigger morning briefing generation at 7am UTC daily
      ScheduleExpression: 'cron(0 7 * * ? *)'
      State: ENABLED
      Targets:
        - Id: MorningBriefingTarget
          Arn: !GetAtt MorningBriefingFunction.Arn

  # Permission for CloudWatch Events to invoke Morning Briefing Lambda
  MorningBriefingSchedulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref MorningBriefingFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MorningBriefingSchedule.Arn

  # Speaker Enrichment Lambda Role
  SpeakerEnrichmentLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-speaker-enrichment-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SpeakerEnrichmentAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub '${TranscriptsBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt TranscriptsIndex.Arn
                  - !Sub '${TranscriptsIndex.Arn}/index/*'
              - Effect: Allow
                Action:
                  - dynamodb:Scan
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:PutItem
                Resource:
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/krisp-speakers'
              - Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt EntitiesTable.Arn
                  - !Sub '${EntitiesTable.Arn}/index/*'
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.nova-lite-v1:0'

  # Speaker Enrichment Lambda Function
  SpeakerEnrichmentFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-speaker-enrichment'
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt SpeakerEnrichmentLambdaRole.Arn
      Timeout: 600
      MemorySize: 512
      Environment:
        Variables:
          KRISP_S3_BUCKET: !Ref TranscriptsBucket
          DYNAMODB_TABLE: !Ref TranscriptsIndex
          SPEAKERS_TABLE: krisp-speakers
          ENTITIES_TABLE: !Ref EntitiesTable
          MODEL_ID: amazon.nova-lite-v1:0
      Code:
        ZipFile: |
          # Placeholder - deploy full code from lambda/speaker-enrichment/handler.py
          def handler(event, context):
              print("Speaker enrichment triggered - deploy full code from repo")
              return {"status": "placeholder"}

  # CloudWatch Events Rule for Nightly Speaker Enrichment (2am UTC)
  SpeakerEnrichmentSchedule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-speaker-enrichment-schedule'
      Description: Trigger speaker enrichment at 2am UTC daily
      ScheduleExpression: 'cron(0 2 * * ? *)'
      State: ENABLED
      Targets:
        - Id: SpeakerEnrichmentTarget
          Arn: !GetAtt SpeakerEnrichmentFunction.Arn

  # Permission for CloudWatch Events to invoke Speaker Enrichment Lambda
  SpeakerEnrichmentSchedulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SpeakerEnrichmentFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt SpeakerEnrichmentSchedule.Arn

Outputs:
  WebhookUrl:
    Description: Krisp Webhook URL - configure this in Krisp settings
    Value: !GetAtt WebhookFunctionUrl.FunctionUrl

  TranscriptsBucket:
    Description: S3 bucket for raw transcripts
    Value: !Ref TranscriptsBucket

  VectorsBucket:
    Description: S3 bucket for vector embeddings
    Value: !Ref VectorsBucket

  DynamoDBTable:
    Description: DynamoDB table for transcript metadata
    Value: !Ref TranscriptsIndex

  CompaniesTable:
    Description: DynamoDB table for company data
    Value: !Ref CompaniesTable

  EntitiesTable:
    Description: DynamoDB table for universal entity store
    Value: !Ref EntitiesTable

  RelationshipsTable:
    Description: DynamoDB table for graph relationships
    Value: !Ref RelationshipsTable

  DocumentsTable:
    Description: DynamoDB table for documents
    Value: !Ref DocumentsTable

  AuditLogsTable:
    Description: DynamoDB table for audit logs (SOC2 compliance)
    Value: !Ref AuditLogsTable

  InvitesTable:
    Description: DynamoDB table for user invitations
    Value: !Ref InvitesTable

  BriefingsTable:
    Description: DynamoDB table for morning briefings
    Value: !Ref BriefingsTable

  MCPServerConfig:
    Description: Environment variables for MCP server
    Value: !Sub |
      KRISP_S3_BUCKET=${TranscriptsBucket}
      DYNAMODB_TABLE=${TranscriptsIndex}
      COMPANIES_TABLE=${CompaniesTable}
      VECTOR_BUCKET=${VectorsBucket}
      VECTOR_INDEX=transcript-chunks
      AWS_REGION=${AWS::Region}

  NextSteps:
    Description: Next steps after deployment
    Value: |
      1. Copy the WebhookUrl to Krisp webhook settings
      2. Deploy full processor Lambda code from repo
      3. Create S3 Vectors index: transcript-chunks
      4. Configure MCP server with the environment variables above
      5. Run backfill scripts if you have existing transcripts
